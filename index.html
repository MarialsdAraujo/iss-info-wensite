<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ISS Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="assets/css/main.css" />
  <style>
    #bg{position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:0;overflow:hidden;}
    #bg .visible{position:absolute;width:100%;height:100%;}
    body{background:none!important;}
    .info-cards{
      display:flex;flex-wrap:wrap;justify-content:center;gap:2rem;margin-top:2rem;
      max-width:1200px;max-height:500px;
      margin-left:auto;margin-right:auto;
    }
    .card{background:rgba(255,255,255,.95);padding:2rem;border-radius:1rem;width:250px;
      box-shadow:0 4px 10px rgba(0,0,0,.3);color:#080808;text-align:center;}
    .card img{max-width:120px;margin-top:1rem;}
    h1{color:#fff;} h2{color:#000;}
  </style>
</head>
<body>

  <!-- Background -->
  <div id="bg">
    <div class="visible top"
      style="background-image:url('images/bg01.jpg');
             background-size:cover;background-position:center;
             filter:brightness(0.4) blur(1px);"></div>
  </div>

  <header id="header" style="position:relative;z-index:2;">
    <h1>ISS Live Tracker</h1>
    <p>Real-time position, weather, and country data from above Earth üåçüõ∞</p>
  </header>

  <section id="main" class="wrapper" style="position:relative;z-index:2;">
    <div class="inner info-cards">
      <div class="card">
        <h2>üìç ISS Location</h2>
        <p>Latitude: <span id="lat">--</span></p>
        <p>Longitude: <span id="lon">--</span></p>
      </div>

      <div class="card">
        <h2>üå§ Weather</h2>
        <p><span id="temp">--</span> ¬∞C</p>
        <p id="weather_desc">--</p>
      </div>

      <div class="card">
        <h2>üåç Country</h2>
        <p>Country: <span id="country">--</span></p>
        <p>Locality: <span id="locality">--</span></p>
        <p>Region: <span id="region">--</span></p>
        <p>Population: <span id="population">--</span></p>
        <img id="flag" alt="Flag or Ocean" style="display:none;width:80px;margin-top:10px;">
        <p id="no-flag" style="display:none;"><em>No flag available</em></p>
      </div>

      <div class="card">
        <h2>üìè Distance</h2>
        <p><span id="distance">--</span> km from</p>
        <p id="myplace">--</p>
        <img id="myflag" alt="My Location Flag" style="width:80px;margin-top:10px;display:none;">
      </div>
    </div>
  </section>

  <footer id="footer" style="position:relative;z-index:2;">
    <ul class="icons">
      <li><a href="http://open-notify.org/Open-Notify-API/ISS-Location-Now/" target="_blank">ISS Location API</a></li>
      <li><a href="https://openweathermap.org/api" target="_blank">Weather API</a></li>
      <li><a href="https://restcountries.com/" target="_blank">Countries API</a></li>
    </ul>
    <ul class="copyright">
      <li>&copy; Maria Luiza de Araujo</li>
      <li>Credits: <a href="http://html5up.net">HTML5 UP</a></li>
    </ul>
  </footer>

  <!-- JS para buscar dados no cliente -->
  <script>
    const OPENWEATHER_KEY = 'open_api';

    const HOME = {
      name: 'Toronto, Canada',
      lat: 43.6532,
      lon: -79.3832,
      flag: 'https://flagcdn.com/ca.svg'
    };

    function haversineKm(lat1, lon1, lat2, lon2){
      const toRad = d => d * Math.PI/180;
      const R = 6371;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    async function loadISS(){
      const iss = await fetch('https://api.wheretheiss.at/v1/satellites/25544').then(r=>r.json());
      document.getElementById('lat').textContent = iss.latitude.toFixed(4);
      document.getElementById('lon').textContent = iss.longitude.toFixed(4);
      return { lat: iss.latitude, lon: iss.longitude };
    }

    async function loadWeather(lat, lon){
      if(!OPENWEATHER_KEY){
        document.getElementById('weather_desc').textContent = 'Add your OpenWeather key';
        return;
      }
      const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric&appid=${OPENWEATHER_KEY}`;
      const w = await fetch(url).then(r=>r.json()).catch(()=>null);
      if(!w || !w.main){
        document.getElementById('weather_desc').textContent = 'Weather unavailable';
        return;
      }
      document.getElementById('temp').textContent = Math.round(w.main.temp);
      document.getElementById('weather_desc').textContent = w.weather?.[0]?.description ?? '--';
    }

    async function loadCountry(lat, lon){
      const g = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=en`)
                      .then(r=>r.json()).catch(()=>null);
      let country = g?.countryName || 'Ocean';
      let region  = g?.principalSubdivision || '--';
      let city    = g?.city || g?.locality || '--';
      let ccode   = (g?.countryCode || '').toLowerCase();

      document.getElementById('country').textContent  = country;
      document.getElementById('region').textContent   = region || '--';
      document.getElementById('locality').textContent = city   || '--';

      if(ccode){
        const r = await fetch(`https://restcountries.com/v3.1/alpha/${ccode}`).then(r=>r.json()).catch(()=>null);
        const info = Array.isArray(r) ? r[0] : null;
        if(info){
          document.getElementById('population').textContent = info.population?.toLocaleString() ?? '--';
          const flagUrl = info.flags?.png || info.flags?.svg;
          if(flagUrl){
            const img = document.getElementById('flag');
            img.src = flagUrl;
            img.style.display = 'inline-block';
            document.getElementById('no-flag').style.display = 'none';
          } else {
            document.getElementById('no-flag').style.display = 'block';
          }
        } else {
          document.getElementById('no-flag').style.display = 'block';
        }
      } else {
        document.getElementById('population').textContent = '--';
        document.getElementById('no-flag').style.display = 'block';
      }
    }

    function fillDistance(lat, lon){
      const d = haversineKm(lat, lon, HOME.lat, HOME.lon);
      document.getElementById('distance').textContent = d.toFixed(2);
      document.getElementById('myplace').textContent  = HOME.name;
      const f = document.getElementById('myflag');
      f.src = HOME.flag;
      f.style.display = 'inline-block';
    }

    async function main(){
      const {lat, lon} = await loadISS();
      await Promise.all([
        loadWeather(lat, lon),
        loadCountry(lat, lon)
      ]);
      fillDistance(lat, lon);
    }
    main();
    setInterval(main, 10000);
  </script>
</body>
</html>
